<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nx Earn — Watch Ads</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Monetag SDK: এখানে আপনার Monetag পক্ষ থেকে দেওয়া SDK URL বসান -->
  <script src="https://js.monetag.com/your-sdk.js"></script>

  <style>
    body{font-family:Inter,Arial;padding:16px;background:#f7f8fb;color:#111}
    .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(12,20,50,0.06);margin-bottom:12px}
    .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer}
    .muted{color:#666;font-size:14px}
  </style>
</head>
<body onload="appInit()">

  <div class="card">
    <h2>Nx Earn (Bot: <b>@NxEarnBot</b>)</h2>
    <p class="muted">আপনি যদি বট থেকে ওয়েব দেখেন নিশ্চয়ই `uid` আছে। না থাকলে বট থেকে খুলুন।</p>
    <div id="status" class="muted">লোড হচ্ছে...</div>
  </div>

  <div class="card">
    <h3>মোট ব্যালেন্স</h3>
    <p style="font-size:20px"><span id="coins">0</span> কয়েন — <span id="balance">৳0.00</span></p>
    <p class="muted">প্রতিটি অ্যাড = 15 কয়েন। দৈনিক ম্যাক্স 20 টি।</p>
  </div>

  <div class="card">
    <h3>টাস্ক</h3>
    <button id="btnInterstitial" class="btn" onclick="watchInterstitial()" >Watch Interstitial (15 coins)</button>
    <button id="btnPopup" class="btn" style="margin-left:10px" onclick="watchPopup()">Watch Popup (15 coins)</button>
    <p class="muted" id="dailyInfo">Daily watched: 0 / 20</p>
  </div>

  <div class="card">
    <h3>রেফার লিংক</h3>
    <p id="shareLink" class="muted">--</p>
    <button class="btn" onclick="copyShare()">Copy Link</button>
  </div>

<script>
/*
  Client logic:
  - expects: url params uid and optionally ref
  - calls server for status (/api/status?uid=...)
  - on Monetag success, calls POST /api/reward to securely give coins
  - IMPORTANT: replace API_BASE and API_KEY with your deployed server values
*/

const API_BASE = "https://your-server.example.com/api"; // <--- আপনার সার্ভার URL
const API_KEY  = "REPLACE_WITH_REAL_KEY";               // <--- সার্ভার-সাইড API key (keep secret on server deployment)

// Monetag functions used: show_9388728() and show_9388728('pop') per your Monetag snippet.
// adjust names if Monetag gave different function names.

let uid = null;
let current = { coins:0, adsWatchedToday:0, dailyLimit:20 };
let lastAdSessionId = null; // prevent duplicate reward calls from same promise

function qs(param){
  return new URLSearchParams(window.location.search).get(param);
}

async function appInit(){
  uid = qs('uid'); // bot should open with ?uid=12345678
  const ref = qs('ref');

  if(!uid){
    document.getElementById('status').innerText = "দয়া করে বট থেকে খুলুন (UID প্রয়োজন)।";
    disableButtons(true);
    return;
  }

  // show share link
  document.getElementById('shareLink').innerText = `${location.origin}${location.pathname}?uid=${uid}&ref=${uid}`;
  // If ref param present, inform server to credit referrer (server will ensure one-time reward)
  if(ref && ref !== uid) {
    // tell server about referral (no coins here for visitor until they watch ads)
    fetch(`${API_BASE}/referral`, {
      method: 'POST',
      headers: {'content-type':'application/json','x-api-key':API_KEY},
      body: JSON.stringify({uid: uid, ref: ref})
    }).catch(e=>console.warn('referral error',e));
  }

  await refreshStatus();
}

function disableButtons(dis){
  document.getElementById('btnInterstitial').disabled = dis;
  document.getElementById('btnPopup').disabled = dis;
  document.getElementById('btnInterstitial').style.opacity = dis?0.5:1;
  document.getElementById('btnPopup').style.opacity = dis?0.5:1;
}

async function refreshStatus(){
  try{
    const res = await fetch(`${API_BASE}/status?uid=${encodeURIComponent(uid)}`, {
      headers:{'x-api-key':API_KEY}
    });
    if(!res.ok) throw new Error('status fetch failed');
    const json = await res.json();
    current.coins = json.coins;
    current.adsWatchedToday = json.adsWatchedToday;
    current.dailyLimit = json.dailyLimit || 20;

    document.getElementById('coins').innerText = current.coins;
    document.getElementById('balance').innerText = `৳${(current.coins/10).toFixed(2)}`;
    document.getElementById('dailyInfo').innerText = `Daily watched: ${current.adsWatchedToday} / ${current.dailyLimit}`;
    document.getElementById('status').innerText = `Welcome, ${uid}`;
    if(current.adsWatchedToday >= current.dailyLimit) disableButtons(true);
    else disableButtons(false);
  }catch(err){
    console.error(err);
    document.getElementById('status').innerText = 'সার্ভার সাথে কানেক্ট করতে ব্যর্থ — পরে চেষ্টা করুন।';
    disableButtons(true);
  }
}

function copyShare(){
  const txt = document.getElementById('shareLink').innerText;
  navigator.clipboard?.writeText(txt).then(()=> alert('Copied!'));
}

// ---------------- Monetag Ad watchers ----------------

function watchInterstitial(){
  if(!uid) return alert('UID নেই। বট থেকে খুলুন।');
  if(current.adsWatchedToday >= current.dailyLimit) return alert('আজকের লিমিট শেষ হয়েছে।');
  disableButtons(true);
  lastAdSessionId = `session_${Date.now()}_${Math.random().toString(36).slice(2,8)}`; // unique
  // call Monetag interstitial
  try {
    show_9388728().then(()=> {
      // success — inform server to reward
      rewardAd('interstitial', lastAdSessionId);
    }).catch(e=>{
      console.warn('Ad error',e);
      alert('অ্যাড চলেনি বা পুরো দেখা হয়নি — কোন ইনকাম নেই।');
      disableButtons(false);
    });
  } catch (e) {
    console.error('Monetag function missing', e);
    alert('Monetag SDK লোড হয়নি।');
    disableButtons(false);
  }
}

function watchPopup(){
  if(!uid) return alert('UID নেই। বট থেকে খুলুন।');
  if(current.adsWatchedToday >= current.dailyLimit) return alert('আজকের লিমিট শেষ হয়েছে।');
  disableButtons(true);
  lastAdSessionId = `session_${Date.now()}_${Math.random().toString(36).slice(2,8)}`; // unique
  try {
    show_9388728('pop').then(()=> {
      // success
      rewardAd('popup', lastAdSessionId);
    }).catch(e=>{
      console.warn('Ad popup error',e);
      alert('অ্যাড চলেনি বা পুরো দেখা হয়নি — কোন ইনকাম নেই।');
      disableButtons(false);
    });
  } catch(e){
    console.error('Monetag function missing', e);
    alert('Monetag SDK লোড হয়নি।');
    disableButtons(false);
  }
}

// call server to securely reward (server enforces daily limit, single reward per session, etc.)
async function rewardAd(type, sessionId){
  try {
    const res = await fetch(`${API_BASE}/reward`, {
      method: 'POST',
      headers: {'content-type':'application/json','x-api-key':API_KEY},
      body: JSON.stringify({
        uid: uid,
        adType: type,
        sessionId: sessionId,
        coins: 15
        // If Monetag provides any proof/token in the future, include it here.
      })
    });
    const json = await res.json();
    if(res.ok){
      // server responded with updated counters
      current.coins = json.coins;
      current.adsWatchedToday = json.adsWatchedToday;
      document.getElementById('coins').innerText = current.coins;
      document.getElementById('balance').innerText = `৳${(current.coins/10).toFixed(2)}`;
      document.getElementById('dailyInfo').innerText = `Daily watched: ${current.adsWatchedToday} / ${current.dailyLimit}`;
      alert(`আপনি 15 কয়েন পেয়েছেন! (আজ ${current.adsWatchedToday}/${current.dailyLimit})`);
      if(current.adsWatchedToday >= current.dailyLimit) disableButtons(true);
      else disableButtons(false);
    } else {
      alert(json.message || "Reward failed");
      disableButtons(false);
    }
  } catch(err){
    console.error(err);
    alert('সার্ভারে সংযোগে সমস্যা — পরে চেষ্টা করুন।');
    disableButtons(false);
  }
}
</script>
</body>
</html>
